# =============================================================================
# GitHub Actions Workflow: Terraform Destroy (Manual with Approval)
# =============================================================================
# This workflow safely destroys the CouchDB infrastructure with manual approval.
#
# Safety features:
# 1. Manual trigger only (no automatic runs)
# 2. Shows destroy plan first
# 3. Requires manual approval before destroying
# 4. Can be cancelled at any time
# =============================================================================

name: "Terraform Destroy"

on:
  workflow_dispatch: # Manual trigger only
    inputs:
      confirm:
        description: 'Type "destroy" to confirm you want to destroy infrastructure'
        required: true
        default: ''

env:
  TF_VERSION: "1.7.0"
  TF_VAR_project_id: ${{ vars.GCP_PROJECT_ID }}
  TF_VAR_couchdb_password: ${{ secrets.COUCHDB_PASSWORD }}
  TF_VAR_tailscale_auth_key: ${{ secrets.TAILSCALE_AUTH_KEY }}
  TF_VAR_enable_https: ${{ vars.ENABLE_HTTPS }}
  TF_VAR_duckdns_subdomain: ${{ vars.DUCKDNS_SUBDOMAIN }}
  TF_VAR_duckdns_token: ${{ secrets.DUCKDNS_TOKEN }}

permissions:
  contents: read
  id-token: write # Required for OIDC

jobs:
  # ===========================================================================
  # Terraform Destroy Plan - Shows what will be destroyed
  # ===========================================================================
  terraform-destroy-plan:
    name: "Show Destroy Plan"
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------------------
      # Validate confirmation input
      # -----------------------------------------------------------------------
      - name: Validate Confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "destroy" ]; then
            echo "âŒ ERROR: You must type 'destroy' to confirm."
            echo "You entered: '${{ github.event.inputs.confirm }}'"
            exit 1
          fi
          echo "âœ… Confirmation validated"

      # -----------------------------------------------------------------------
      # Checkout repository
      # -----------------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Authenticate to GCP
      # -----------------------------------------------------------------------
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.WIF_PROVIDER }}
          service_account: ${{ vars.WIF_SERVICE_ACCOUNT }}
          create_credentials_file: true
          export_environment_variables: true

      # -----------------------------------------------------------------------
      # Setup Terraform
      # -----------------------------------------------------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      # -----------------------------------------------------------------------
      # Terraform Init
      # -----------------------------------------------------------------------
      - name: Terraform Init
        run: terraform init

      # -----------------------------------------------------------------------
      # Terraform Destroy Plan
      # Shows exactly what will be destroyed
      # -----------------------------------------------------------------------
      - name: Terraform Destroy Plan
        id: plan
        run: |
          echo "## ğŸ”´ Destroy Plan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following resources will be **DESTROYED**:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          terraform plan -destroy -no-color | tee destroy_plan.txt

          echo '```' >> $GITHUB_STEP_SUMMARY
          cat destroy_plan.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Review the plan above carefully before approving!**" >> $GITHUB_STEP_SUMMARY

      # -----------------------------------------------------------------------
      # Upload plan for next job
      # -----------------------------------------------------------------------
      - name: Upload Destroy Plan
        uses: actions/upload-artifact@v4
        with:
          name: destroy-plan
          path: destroy_plan.txt

  # ===========================================================================
  # Manual Approval - Requires human approval before destroying
  # ===========================================================================
  wait-for-approval:
    name: "â¸ï¸ Waiting for Manual Approval"
    runs-on: ubuntu-latest
    needs: terraform-destroy-plan
    environment:
      name: destroy-approval
      # This environment requires manual approval in GitHub settings

    steps:
      - name: Manual Approval Required
        run: |
          echo "âœ‹ This step requires manual approval"
          echo "ğŸ“‹ Review the destroy plan above"
          echo "âœ… Approve in the GitHub UI to proceed with destruction"
          echo "âŒ Cancel the workflow to abort"

  # ===========================================================================
  # Terraform Destroy - Actually destroys the infrastructure
  # ===========================================================================
  terraform-destroy:
    name: "ğŸ”¥ Execute Destroy"
    runs-on: ubuntu-latest
    needs: wait-for-approval
    # Only runs after manual approval

    steps:
      # -----------------------------------------------------------------------
      # Checkout repository
      # -----------------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Authenticate to GCP
      # -----------------------------------------------------------------------
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.WIF_PROVIDER }}
          service_account: ${{ vars.WIF_SERVICE_ACCOUNT }}
          create_credentials_file: true
          export_environment_variables: true

      # -----------------------------------------------------------------------
      # Setup Terraform
      # -----------------------------------------------------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      # -----------------------------------------------------------------------
      # Terraform Init
      # -----------------------------------------------------------------------
      - name: Terraform Init
        run: terraform init

      # -----------------------------------------------------------------------
      # Terraform Destroy
      # -----------------------------------------------------------------------
      - name: Terraform Destroy
        run: |
          echo "ğŸ”¥ Destroying infrastructure..."
          terraform destroy -auto-approve

          echo "## âœ… Infrastructure Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All resources have been destroyed successfully." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Destroyed at:** $(date -u)" >> $GITHUB_STEP_SUMMARY

      # -----------------------------------------------------------------------
      # Notification
      # -----------------------------------------------------------------------
      - name: Destroy Complete
        run: |
          echo "âœ… Terraform destroy completed successfully"
          echo "ğŸ—‘ï¸  All infrastructure has been removed"
          echo "ğŸ’¾ Terraform state file remains in GCS bucket"
